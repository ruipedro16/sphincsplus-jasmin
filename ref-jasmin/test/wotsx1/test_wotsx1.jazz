from Sphincs require "wotsx1/wotsx1.jtmpl"
from Sphincs require "generic/utils.jtmpl"

////////////////////////////////////////////////////////////////////////////////

export fn wots_gen_leafx1_jazz(reg u64 args)
{
  // arguments[0] = (void *)dest;
  // arguments[1] = (void *)ctx->pub_seed;
  // arguments[2] = (void *)ctx->sk_seed;
  // arguments[3] = (void *)&leaf_idx;
  // arguments[4] = (void *)((struct leaf_info_x1 *)info)->wots_sig;
  // arguments[5] = (void *)((struct leaf_info_x1 *)info)->wots_sign_leaf;
  // arguments[6] = (void *)((struct leaf_info_x1 *)info)->wots_steps;
  // arguments[7] = (void *)((struct leaf_info_x1 *)info)->leaf_addr;
  // arguments[8] = (void *)((struct leaf_info_x1 *)info)->pk_addr;

  reg u64 dest_ptr pub_seed_ptr sk_seed_ptr wots_sig_ptr wots_steps_ptr leaf_addr_ptr pk_addr_ptr _ptr_;
  reg u32 leaf_idx wots_sign_leaf;

  stack   u8[SPX_N] dest;
  reg ptr u8[SPX_N] dest_p;

  stack   u8[SPX_N] pub_seed;
  reg ptr u8[SPX_N] pub_seed_p;

  stack   u8[SPX_N] sk_seed;
  reg ptr u8[SPX_N] sk_seed_p;

  stack   u8[SPX_TREE_HEIGHT * SPX_N + SPX_WOTS_BYTES] wots_sig;
  reg ptr u8[SPX_TREE_HEIGHT * SPX_N + SPX_WOTS_BYTES] wots_sig_p;

  stack   u32[SPX_WOTS_LEN] wots_steps;
  reg ptr u32[SPX_WOTS_LEN] wots_steps_p;

  stack   u32[8] leaf_addr;
  reg ptr u32[8] leaf_addr_p;

  stack   u32[8] pk_addr;
  reg ptr u32[8] pk_addr_p;

  args = args;

  pub_seed_ptr = (u64) [args + 8*1];
  pub_seed_p   = pub_seed;
  pub_seed_p   = __load_u8_array<SPX_N>(pub_seed_p, pub_seed_ptr);

  // pub_seed_p = #randombytes(pub_seed_p);

  sk_seed_ptr = (u64) [args + 8*2];
  sk_seed_p   = sk_seed;
  sk_seed_p   = __load_u8_array<SPX_N>(sk_seed_p, sk_seed_ptr);

  // sk_seed_p = #randombytes(sk_seed_p);

  _ptr_    = (u64) [args + 8*3];
  leaf_idx = (u32) [_ptr_];

  // stack u32[2] debug_buffer; debug_buffer[0] = leaf_idx; debug_buffer[1] = wots_sign_leaf;
  // debug_buffer[0:1] = #randombytes(debug_buffer[0:1]);

  wots_sig_ptr = (u64) [args + 8*4];
  wots_sig_p   = wots_sig;
  wots_sig_p   = __load_u8_array<SPX_TREE_HEIGHT * SPX_N + SPX_WOTS_BYTES>(wots_sig_p, wots_sig_ptr);

  // wots_sig_p = #randombytes(wots_sig_p);

  _ptr_          = (u64) [args + 8*5];
  wots_sign_leaf = (u32) [_ptr_];

  // stack u32[2] debug_buffer; debug_buffer[0] = leaf_idx; debug_buffer[1] = wots_sign_leaf;
  // debug_buffer[1:1] = #randombytes(debug_buffer[1:1]);

  wots_steps_ptr = (u64) [args + 8*6];
  wots_steps_p   = wots_steps;
  wots_steps_p   = __load_u32_array<SPX_WOTS_LEN>(wots_steps_p, wots_steps_ptr);

  // wots_steps_p = #randombytes(wots_steps_p);

  leaf_addr_ptr = (u64) [args + 8*7];
  leaf_addr_p   = leaf_addr;
  leaf_addr_p   = __load_u32_array<8>(leaf_addr_p, leaf_addr_ptr);
  
  // leaf_addr_p = #randombytes(leaf_addr_p);

  pk_addr_ptr = (u64) [args + 8*8];
  pk_addr_p   = pk_addr;
  pk_addr_p   = __load_u32_array<8>(pk_addr_p, pk_addr_ptr);

  // pk_addr_p = #randombytes(pk_addr_p);

  () = #spill(args);

  dest_p = dest;
  dest_p, wots_sig_p, leaf_addr_p, pk_addr_p = _wots_gen_leafx1(dest_p, pub_seed_p, sk_seed_p, 
                                                                leaf_idx, wots_sig_p, wots_sign_leaf, 
                                                                wots_steps_p, leaf_addr_p, pk_addr_p);

  () = #unspill(args);
  dest_ptr = (64u)[args + 8*0];

  __store_u8_array<SPX_N>(dest_p, dest_ptr);
}
